name: Devths-BE CI íŒŒì´í”„ë¼ì¸

# dev/release/main ëª¨ë‘ ì§„í–‰
on:
  pull_request:
    branches: [develop, release, main]

# ENV ì„¤ì •
env:
  JAVA_VERSION: "21"

jobs:
  # Lint ì„¤ì •
  lint:
    name: lint
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      checks: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Lint (CheckStyle) ìˆ˜í–‰
        run: ./gradlew checkstyleMain

      - name: Lint (CheckStyle) ê²°ê³¼ ë¦¬í¬íŠ¸
        uses: lcollins/checkstyle-github-action@v2.0.0
        if: always()
        with:
            path: '**/build/reports/checkstyle/*.xml'
            title: 'Checkstyle ê²°ê³¼ Report'

  # CodeQL ê¸°ë°˜ ì½”ë“œ ì •ì  ë¶„ì„ ì‹¤í–‰
  static_analysis:
    name: static-analysis
    needs: [ lint ]
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: [ java-kotlin ]
    # container ë¶€ë¶„ì€ ì œê±° (GitHub ê¸°ë³¸ í™˜ê²½ ì‚¬ìš© ê¶Œì¥)
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Build (Gradle)
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      - name: CodeQL ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v3

  # ì¶”í›„ í†µí•© í…ŒìŠ¤íŠ¸ ê³¼ì • ì¶”ê°€ ì˜ˆì •

  # ë¹Œë“œ
  build:
    name: build
    runs-on: ubuntu-22.04
    needs: [static_analysis] # í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ ë¹Œë“œ
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: ìë°” ë¹Œë“œ
        run: ./gradlew clean build -x test

  # ë””ìŠ¤ì½”ë“œ ì•ŒëŒ ì œê³µ
  notify-discord:
    name: notify
    runs-on: ubuntu-22.04
    needs: [lint, static_analysis, build]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„ (JSON ê¸°ë°˜ ë§¤í•‘ ë° ë¦¬ë·°ì–´ ì¶”ì¶œ)
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì‘ì„±ì ë§¤í•‘
          LOGIN_ID="${{ github.event.pull_request.user.login }}"
          # JSONì—ì„œ í•´ë‹¹ IDì˜ ê°’ì„ ê°€ì ¸ì˜´
          AUTHOR_MAPPED=$(echo '$USER_MAP' | jq -r --arg id "$LOGIN_ID" '.[$id] // $id')
          echo "author=$AUTHOR_MAPPED" >> $GITHUB_OUTPUT

          # 2. ì½”ë“œ ë¦¬ë·°ì–´ ì¶”ì¶œ ë° ë§¤í•‘
          RAW_REVIEWERS=$(echo '${{ toJson(github.event.pull_request.requested_reviewers) }}' | jq -r '.[].login')
          MAPPED_REVIEWERS=""
          
          for LOGIN in $RAW_REVIEWERS; do
            # JSONì—ì„œ ë§¤í•‘ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
            M_NAME=$(echo '$USER_MAP' | jq -r --arg id "$LOGIN" '.[$id] // $id')
            if [ -z "$MAPPED_REVIEWERS" ]; then
              MAPPED_REVIEWERS="$M_NAME"
            else
              MAPPED_REVIEWERS="$MAPPED_REVIEWERS, $M_NAME"
            fi
          done

          if [ -z "$MAPPED_REVIEWERS" ]; then MAPPED_REVIEWERS="ì§€ì • ì•ˆ ë¨"; fi
          echo "reviewers=$MAPPED_REVIEWERS" >> $GITHUB_OUTPUT

          # 3. PR ë‚´ìš© ìš”ì•½ (100ì ì œí•œ)
          PR_BODY=$(cat << 'EOF' | head -c 100
          ${{ github.event.pull_request.body }}
          EOF
          )
          PR_BODY="${PR_BODY//$'\n'/' '}"
          echo "pr_body=$PR_BODY" >> $GITHUB_OUTPUT

      - name: Discord ë¹Œë“œ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          status: ${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          webhook: ${{ github.event.pull_request.base.ref == 'main' && secrets.DISCORD_WEBHOOK_PROD_URL || secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
          title: "${{ github.event.pull_request.base.ref }} ë³‘í•© [${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}] ë˜ì—ˆìŠµë‹ˆë‹¤!"
          description: |
            **PR ì œëª©**: ${{ github.event.pull_request.title }}
            **ì‘ì„±ì**: ${{ steps.prep.outputs.author }}
            **ë¦¬ë·°ì–´ ìš”ì²­**: ${{ steps.prep.outputs.reviewers }}
            **ê²½ë¡œ**: `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
            **í™˜ê²½**: ${{ github.event.pull_request.base.ref == 'main' && 'ğŸš€ ìš´ì˜(PROD)' || (github.event.pull_request.base.ref == 'release' && 'ğŸ§ª ìŠ¤í…Œì´ì§•(STAGING)' || 'ğŸ› ï¸ ê°œë°œ(DEV)') }}
            
            **ğŸ“ PR ë‚´ìš© ìš”ì•½**:
            > ${{ steps.prep.outputs.pr_body }}...
            
            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint: ${{ needs.lint.result == 'success' && 'âœ… success' || 'âŒ failure' }}
            - Static Analysis: ${{ needs.static_analysis.result == 'success' && 'âœ… success' || 'âŒ failure' }}
            - Build: ${{ needs.build.result == 'success' && 'âœ… success' || 'âŒ failure' }}
            
            **ğŸ”— ë§í¬**: [PR í™•ì¸í•˜ê¸°](${{ github.event.pull_request.html_url }})

          color: "${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub PR Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
