name: Devths-BE CI íŒŒì´í”„ë¼ì¸

# dev/release/main ëª¨ë‘ ì§„í–‰
on:
  pull_request:
    branches: [ develop, release, main ]

# ENV ì„¤ì •
env:
  JAVA_VERSION: "21"

jobs:
  # Lint ì„¤ì •
  lint:
    name: lint
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      checks: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Lint (CheckStyle) ìˆ˜í–‰
        run: ./gradlew checkstyleMain

      - name: Lint (CheckStyle) ê²°ê³¼ ë¦¬í¬íŠ¸
        uses: lcollins/checkstyle-github-action@v2.0.0
        if: always()
        with:
          path: '**/build/reports/checkstyle/*.xml'
          title: 'Checkstyle ê²°ê³¼ Report'

  # CodeQL ê¸°ë°˜ ì½”ë“œ ì •ì  ë¶„ì„ ì‹¤í–‰
  static_analysis:
    name: static-analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: true  # ì •ì  ë¶„ì„ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
      matrix:
        language: [ java-kotlin ]
    # container ë¶€ë¶„ì€ ì œê±° (GitHub ê¸°ë³¸ í™˜ê²½ ì‚¬ìš© ê¶Œì¥)
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml

      - name: Build (Gradle)
        run: |
          chmod +x gradlew
          ./gradlew build -x test -x check

      - name: CodeQL ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
          upload: true

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê°œìˆ˜ í™•ì¸ ë° ë¹Œë“œ ì°¨ë‹¨
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” í˜„ì¬ ì»¤ë°‹ì˜ ë³´ì•ˆ ì·¨ì•½ì ì„ í™•ì¸ ì¤‘..."
          echo "ğŸ“ Commit SHA: ${{ github.event.pull_request.head.sha }}"

          # CodeQL ê²°ê³¼ê°€ APIì— ë°˜ì˜ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "â³ CodeQL ê²°ê³¼ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ ..."
          sleep 30

          # í˜„ì¬ PRì˜ head SHAë¡œ í•„í„°ë§í•˜ì—¬ Code Scanning ê²°ê³¼ ì¡°íšŒ
          CURRENT_SHA="${{ github.event.pull_request.head.sha }}"

          # í˜„ì¬ ì»¤ë°‹ì—ì„œ ë°œê²¬ëœ ë³´ì•ˆ ì·¨ì•½ì ë§Œ í•„í„°ë§ (vulnerable íŒ¨í‚¤ì§€ ì œì™¸)
          # vulnerable íŒ¨í‚¤ì§€ëŠ” ì˜ë„ì ì¸ í…ŒìŠ¤íŠ¸ ì½”ë“œì´ë¯€ë¡œ ë¹Œë“œ ì°¨ë‹¨ì—ì„œ ì œì™¸
          ALERTS=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=refs/heads/${{ github.event.pull_request.head.ref }}" \
            --jq "[.[] | select(.most_recent_instance.ref == \"refs/heads/${{ github.event.pull_request.head.ref }}\") | select(.rule.security_severity_level != null) | select(.most_recent_instance.location.path | contains(\"/vulnerable/\") | not)] | length")

          echo "âš ï¸ í˜„ì¬ ë¸Œëœì¹˜ì—ì„œ ë°œê²¬ëœ ë³´ì•ˆ ì·¨ì•½ì : $ALERTSê°œ (vulnerable íŒ¨í‚¤ì§€ ì œì™¸)"

          # ì·¨ì•½ì  ìƒì„¸ ì •ë³´ ì¶œë ¥
          if [ "$ALERTS" -gt 0 ]; then
            echo ""
            echo "ğŸ“‹ ë°œê²¬ëœ ì·¨ì•½ì  ëª©ë¡:"
            gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=refs/heads/${{ github.event.pull_request.head.ref }}" \
              --jq '.[] | select(.most_recent_instance.ref == "refs/heads/${{ github.event.pull_request.head.ref }}") | select(.rule.security_severity_level != null) | select(.most_recent_instance.location.path | contains("/vulnerable/") | not) | "  - [\(.rule.severity)] \(.rule.description) (\(.most_recent_instance.location.path):\(.most_recent_instance.location.start_line))"' || true
          fi

          # vulnerable íŒ¨í‚¤ì§€ì˜ ì·¨ì•½ì  ê°œìˆ˜ë„ í‘œì‹œ (ì •ë³´ìš©)
          VULNERABLE_ALERTS=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=refs/heads/${{ github.event.pull_request.head.ref }}" \
            --jq "[.[] | select(.most_recent_instance.ref == \"refs/heads/${{ github.event.pull_request.head.ref }}\") | select(.rule.security_severity_level != null) | select(.most_recent_instance.location.path | contains(\"/vulnerable/\"))] | length")

          if [ "$VULNERABLE_ALERTS" -gt 0 ]; then
            echo ""
            echo "â„¹ï¸ vulnerable íŒ¨í‚¤ì§€ì—ì„œ ê°ì§€ëœ ì·¨ì•½ì : $VULNERABLE_ALERTSê°œ (ì˜ë„ì ì¸ í…ŒìŠ¤íŠ¸ ì½”ë“œ, ë¹Œë“œ ì°¨ë‹¨ ì œì™¸)"
          fi

          # ì·¨ì•½ì ì´ ìˆìœ¼ë©´ ë¹Œë“œ ì°¨ë‹¨
          if [ "$ALERTS" -gt 0 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ CRITICAL: ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“Š ë°œê²¬ëœ ì·¨ì•½ì  ìˆ˜: $ALERTSê°œ"
            echo "ğŸ”— ìƒì„¸ ë‚´ì—­: https://github.com/${{ github.repository }}/security/code-scanning"
            echo ""
            echo "âš ï¸ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:"
            echo "  1. ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ì·¨ì•½ì  í•´ê²°"
            echo "  2. GitHub Security íƒ­ì—ì„œ False Positiveì¸ ê²½ìš° 'Dismiss' ì²˜ë¦¬"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          else
            echo ""
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼! ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

  # ì¶”í›„ í†µí•© í…ŒìŠ¤íŠ¸ ê³¼ì • ì¶”ê°€ ì˜ˆì •

  # ë¹Œë“œ
  build:
    name: build
    runs-on: ubuntu-22.04
    needs: [ lint, static_analysis ]
    if: success()
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: ìë°” ë¹Œë“œ
        run: ./gradlew clean build -x test -x check

  # ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì œê³µ
  notify-discord:
    name: notify
    runs-on: ubuntu-22.04
    needs: [ lint, static_analysis, build ]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì‘ì„±ì ë§¤í•‘
          LOGIN_ID="${{ github.event.pull_request.user.login }}"
          AUTHOR_TAG=$(echo "$USER_MAP" | jq -r --arg id "$LOGIN_ID" '.[$id] // $id')
          echo "author=$AUTHOR_TAG" >> $GITHUB_OUTPUT

          # 2. ë¦¬ë·°ì–´ ë§¤í•‘ 
          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ë·°ì–´ login ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¨ ë’¤, MAPì—ì„œ ì°¾ì•„ ë””ìŠ¤ì½”ë“œ ë©˜ì…˜ìœ¼ë¡œ ë³€í™˜
          REVIEWERS_JSON='${{ toJson(github.event.pull_request.requested_reviewers) }}'
          REVIEWER_TAGS=$(echo "$REVIEWERS_JSON" | jq -r --argjson map "$USER_MAP" '
            [.[].login | ($map[.] // .)] | join(", ")
          ')
          echo "reviewers=${REVIEWER_TAGS:-ì—†ìŒ}" >> $GITHUB_OUTPUT

          # 3. ì‘ì—… ë‚´ìš© ì¶”ì¶œ (HTML ì£¼ì„ ì œê±° ë¡œì§ ë°˜ì˜)
          PR_RAW_BODY=$(cat << 'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          
          # í•„ìš”ì—†ëŠ” ë¬¸êµ¬ ì‚­ì œ
          DESC=$(echo "$PR_RAW_BODY" | \
            perl -0777 -pe 's///gs' | \
            sed 's/ì´ PRì—ì„œ ë³€ê²½ëœ ë‚´ìš©ì„ ê°„ëµíˆ ì‘ì„±í•´ì£¼ì„¸ìš”\.//g' | \
            sed -n '/## ğŸ“Œ ì‘ì—…í•œ ë‚´ìš©/,/## ğŸ” ì°¸ê³  ì‚¬í•­/p' | \
            sed '1d;$d' | \
            xargs | \
            head -c 300)
          
          echo "description=${DESC:-ë‚´ìš© ì—†ìŒ}" >> $GITHUB_OUTPUT

      - name: Discord ë¹Œë“œ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          status: ${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "${{ github.event.pull_request.base.ref }} PR [${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **PR ì œëª©**: ${{ github.event.pull_request.title }}
            **ì‘ì„±ì**: ${{ steps.prep.outputs.author }}
            **ë¦¬ë·°ì–´**: ${{ steps.prep.outputs.reviewers }}
            **ì‘ì—… ë‚´ìš©**: ${{ steps.prep.outputs.description }}...
            **ê²½ë¡œ**: `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
            
            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint: ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ FAILED' }}
            - Static Analysis (CodeQL): ${{ needs.static_analysis.result == 'success' && 'âœ…' || 'âŒ FAILED' }}
            - Build: ${{ needs.build.result == 'success' && 'âœ…' || (needs.build.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED') }}

            ${{ needs.static_analysis.result != 'success' && 'âš ï¸ **ì •ì  ë¶„ì„ ì‹¤íŒ¨ë¡œ ì¸í•´ ë¹Œë“œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.**' || '' }}

            **ğŸ”— ë§í¬**: [PR í™•ì¸í•˜ê¸°](${{ github.event.pull_request.html_url }})
          color: "${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub PR Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
