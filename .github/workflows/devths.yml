name: Devths-BE CICD íŒŒì´í”„ë¼ì¸

# dev/release/main ëª¨ë‘ ì§„í–‰
on:
  push:
    branches: [ develop, release, main ]

# ë™ì‹œì„± ì œì–´: ë™ì¼í•œ ë¸Œëœì¹˜ì— ìƒˆë¡œìš´ ì»¤ë°‹ì´ ì˜¤ë©´ ì´ì „ ì›Œí¬í”Œë¡œìš° ì·¨ì†Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ENV ì„¤ì •
env:
  JAVA_VERSION: "21"
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET: ${{ github.ref_name == 'main' && secrets.AWS_S3_BUCKET_PROD || secrets.AWS_S3_BUCKET }}
  S3_PREFIX: BE/${{ github.ref_name }}
  CODEDEPLOY_APPLICATION: ${{ secrets.CODEDEPLOY_APPLICATION }}
  # ë¸Œëœì¹˜ë³„ ë°°í¬ ê·¸ë£¹ ì´ë¦„ ë¶„ê¸° (main=Devths-V1-BE-PROD-Group, release=Devths-V1-BE-STAGING-Group, develop=Devths-V1-BE-Dev-Group)
  CODE_DEPLOY_GROUP_NAME: ${{ github.ref_name == 'main' && secrets.CODE_DEPLOY_GROUP_NAME_PROD || (github.ref_name == 'release' && secrets.CODE_DEPLOY_GROUP_NAME_STAGING || secrets.CODE_DEPLOY_GROUP_NAME_DEV) }}

jobs:
  # Lint ì„¤ì •
  lint:
    name: lint
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      checks: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Lint (CheckStyle) ìˆ˜í–‰
        run: ./gradlew checkstyleMain

      - name: Lint (CheckStyle) ê²°ê³¼ ë¦¬í¬íŠ¸
        uses: lcollins/checkstyle-github-action@v2.0.0
        if: always()
        with:
          path: '**/build/reports/checkstyle/*.xml'
          title: 'Checkstyle ê²°ê³¼ Report'

  # CodeQL ê¸°ë°˜ ì½”ë“œ ì •ì  ë¶„ì„ ì‹¤í–‰
  build_and_analyze:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: true  # ì •ì  ë¶„ì„ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
      matrix:
        language: [ java-kotlin ]

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          config-file: "./.github/codeql/code-ql-heavy.yml"

      - name: Build (Gradle)
        run: |
          chmod +x gradlew
          ./gradlew build -x test -x check

      - name: CodeQL ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
          upload: true

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê²°ê³¼ í™•ì¸ ë° ì°¨ë‹¨
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â³ ë¶„ì„ ê²°ê³¼ê°€ GitHubì— ë°˜ì˜ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ (10ì´ˆ)..."
          sleep 10
          
          # 1. í˜„ì¬ ì´ë²¤íŠ¸ê°€ pushì¸ì§€ prì¸ì§€ì— ë”°ë¼ ê²€ìƒ‰í•  REF ì„¤ì •
          # GITHUB_REFëŠ” pushì¼ ë• refs/heads/branchëª…, PRì¼ ë• refs/pull/ë²ˆí˜¸/mergeê°€ ë©ë‹ˆë‹¤.
          CURRENT_REF="${{ github.ref }}"
          echo "ğŸ“ í˜„ì¬ Ref: $CURRENT_REF"
          
          # 2. API í˜¸ì¶œí•˜ì—¬ High/Critical ë“±ê¸‰ì˜ Open ìƒíƒœì¸ ì•Œë¦¼ ì¡°íšŒ
          ALERTS=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=$CURRENT_REF" \
            --jq '[.[] | select(.rule.security_severity_level == "high" or .rule.security_severity_level == "critical")]')
          
          COUNT=$(echo "$ALERTS" | jq 'length')
          
          if [ "$COUNT" -gt 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨: ê³ ìœ„í—˜(High/Critical) ì·¨ì•½ì  $COUNTê°œ ë°œê²¬"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$ALERTS" | jq -r '.[] | "- [\(.rule.security_severity_level)] \(.rule.description) \n   ìœ„ì¹˜: \(.most_recent_instance.location.path)"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          else
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼: í˜„ì¬ ì»¤ë°‹($CURRENT_REF)ì€ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/*.jar
          retention-days: 1

  # ì¶”í›„ í†µí•© í…ŒìŠ¤íŠ¸ ê³¼ì • ì¶”ê°€ ì˜ˆì •

  # S3 ì—…ë¡œë“œ ë° CodeDeploy íŠ¸ë¦¬ê±°
  deploy:
    name: deploy
    runs-on: ubuntu-22.04
    needs: [ lint, build_and_analyze ] # í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ ë¹Œë“œ ë° ë°°í¬
    if: success()
    outputs:
      deployment_id: ${{ steps.codedeploy.outputs.deployment_id }}
      s3_key: ${{ steps.codedeploy.outputs.s3_key }}

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_KEY}}
          aws-region: ${{secrets.AWS_REGION}}

      - name: ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (JAR + Scripts)
        id: package
        run: |
          set -euo pipefail

          # 1. ë²„ì „ ì •ë³´ ìƒì„±
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          VERSION_NAME="$(date +'%Y%m%d_%H%M%S')-$SHORT_SHA"
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

          # 2. ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ ì°¾ê¸° ë° ì´ë¦„ ê³ ì •
          ORIGINAL_JAR=$(ls build/libs/*.jar | grep -v 'plain' | head -n 1)
          if [ -z "$ORIGINAL_JAR" ]; then
            echo "âŒ ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # 3. ë°°í¬ìš© ë””ë ‰í† ë¦¬ êµ¬ì„±
          mkdir -p deploy-package
          cp "$ORIGINAL_JAR" "deploy-package/application.jar"
          
          # 4. appspec.yml ë° scripts ë³µì‚¬ (ì¡´ì¬í•  ê²½ìš°)
          if [ -f "appspec.yml" ]; then
            cp appspec.yml deploy-package/
          else
            echo "âš ï¸ appspec.ymlì´ ì—†ìŠµë‹ˆë‹¤. CodeDeploy ì‹¤íŒ¨ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤."
          fi

          if [ -d "scripts" ]; then
            cp -r scripts deploy-package/
          else
            echo "âš ï¸ scripts ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

          # 6. ZIP ì••ì¶•
          cd deploy-package
          zip -r "../$VERSION_NAME.zip" ./*
          cd ..
          
          echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ: $VERSION_NAME.zip"
          ls -lh "$VERSION_NAME.zip"

      - name: S3ë¡œ ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
        run: |
          VERSION_NAME="${{ steps.package.outputs.version_name }}"
          DEST="s3://${S3_BUCKET}/${S3_PREFIX}"
          
          echo "ğŸš€ Uploading $VERSION_NAME.zip to $DEST"
          aws s3 cp "$VERSION_NAME.zip" "$DEST/$VERSION_NAME.zip" --only-show-errors

      - name: AWS CodeDeploy ë°°í¬ ìš”ì²­
        id: codedeploy
        if: github.ref_name != 'main' # ìš´ì˜(main)ì€ S3 ì—…ë¡œë“œê¹Œì§€ë§Œ ìˆ˜í–‰í•˜ê³ , ë°°í¬ íŠ¸ë¦¬ê±°ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰
        run: |
          VERSION_NAME="${{ steps.package.outputs.version_name }}"
          
          echo "ğŸš€ CodeDeploy ë°°í¬ ìƒì„± ìš”ì²­..."
          aws deploy create-deployment \
            --application-name ${{ env.CODEDEPLOY_APPLICATION }} \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --deployment-group-name ${{ env.CODE_DEPLOY_GROUP_NAME }} \
            --s3-location bucket=${S3_BUCKET},bundleType=zip,key=${S3_PREFIX}/$VERSION_NAME.zip \
            --description "Deployed via GitHub Actions: $VERSION_NAME" \
            --output json > deployment_output.json

          DEPLOYMENT_ID=$(jq -r '.deploymentId' deployment_output.json)
          S3_KEY="${S3_PREFIX}/$VERSION_NAME.zip"
          
          # GITHUB_OUTPUTì— ê°’ ê¸°ë¡
          echo "s3_key=$S3_KEY" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
          echo "ğŸš€ Deployment ID: $DEPLOYMENT_ID"
          echo "ğŸ“‚ S3 Key: $S3_KEY"

  # CI ë‹¨ê³„ Discord ì•Œë¦¼ (Build & Upload)
  notify-ci:
    name: notify-ci
    runs-on: ubuntu-22.04
    needs: [ lint, build_and_analyze, deploy ]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì»¤ë°‹ ë©”ì‹œì§€ ì¶”ì¶œ
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "title=$COMMIT_MSG" >> $GITHUB_OUTPUT

          # 2. ë¸Œëœì¹˜ ì •ë³´
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Discord ë¹Œë“œ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          status: ${{ (needs.lint.result == 'success' && needs.build_and_analyze.result == 'success' && (needs.deploy.result == 'success' || needs.deploy.result == 'skipped')) && 'success' || 'failure' }}
          # íƒ€ê²Ÿ ë¸Œëœì¹˜ì— ë”°ë¥¸ ì›¹í›… ë¶„ê¸°
          webhook: ${{ github.ref_name == 'main' && secrets.DISCORD_WEBHOOK_PROD_URL || secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
          title: "ë°°í¬(CI) ê²°ê³¼ [${{ (needs.lint.result == 'success' && needs.build_and_analyze.result == 'success' && (needs.deploy.result == 'success' || needs.deploy.result == 'skipped')) && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ì»¤ë°‹ ë©”ì‹œì§€**: ${{ steps.prep.outputs.title }}
            **ë¸Œëœì¹˜**: `${{ steps.prep.outputs.branch }}`
            **í™˜ê²½**: ${{ github.ref_name == 'main' && 'ğŸš€ ìš´ì˜(PROD)' || (github.ref_name == 'release' && 'ğŸ§ª ìŠ¤í…Œì´ì§•(STAGING)' || 'ğŸ› ï¸ ê°œë°œ(DEV)') }}
            
            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint: ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }}
            - Static Analysis: ${{ needs.build_and_analyze.result == 'success' && 'âœ…' || 'âŒ' }}
            - Deployment: ${{ needs.deploy.result == 'success' && 'âœ…' || (needs.deploy.result == 'skipped' && 'â­ï¸' || 'âŒ') }}

            ${{ needs.build_and_analyze.result != 'success' && 'âš ï¸ **ì •ì  ë¶„ì„ ì‹¤íŒ¨ë¡œ ì¸í•´ ë¹Œë“œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.**' || '' }}
            **ğŸ“‚ S3 Key**: `${{needs.deploy.outputs.s3_key}}`
            **ğŸ”— ë§í¬**: [ì»¤ë°‹ í™•ì¸í•˜ê¸°](${{ github.event.repository.html_url }}/commit/${{ github.sha }})

          color: "${{ (needs.lint.result == 'success' && needs.build_and_analyze.result == 'success' && (needs.deploy.result == 'success' || needs.deploy.result == 'skipped')) && 65280 || 16711680 }}"
          username: GitHub Merge Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

  # CD ë‹¨ê³„ ì•Œë¦¼ (CodeDeploy Result) - ìš´ì˜(main) ì œì™¸
  notify-cd:
    name: notify-cd
    runs-on: ubuntu-22.04
    needs: [ deploy ]
    if: needs.deploy.result == 'success' && github.ref_name != 'main'
    steps:
      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_KEY}}
          aws-region: ${{secrets.AWS_REGION}}

      - name: CodeDeploy ì™„ë£Œ ëŒ€ê¸° ë° ê²°ê³¼ ì¡°íšŒ
        id: cd-check
        run: |
          DEPLOYMENT_ID="${{ needs.deploy.outputs.deployment_id }}"
          echo "â³ Waiting for CodeDeploy ($DEPLOYMENT_ID)..."
          
          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID || true
          
          # ìƒíƒœ ì¡°íšŒ
          STATUS=$(aws deploy get-deployment --deployment-id $DEPLOYMENT_ID --query "deploymentInfo.status" --output text)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          if [ "$STATUS" == "Succeeded" ]; then
             echo "âœ… ë°°í¬ ì„±ê³µ"
          else
             echo "âŒ ë°°í¬ ì‹¤íŒ¨"
          fi
          
          # Lifecycle Event ìƒì„¸ ì¡°íšŒ (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ê¸°ì¤€)
          INSTANCE_ID=$(aws deploy list-deployment-instances --deployment-id $DEPLOYMENT_ID --query "instancesList[0]" --output text)
          
          if [ "$INSTANCE_ID" != "None" ] && [ -n "$INSTANCE_ID" ]; then
            EVENTS=$(aws deploy get-deployment-instance --deployment-id $DEPLOYMENT_ID --instance-id $INSTANCE_ID --query "instanceSummary.lifecycleEvents")
          
            # ê° ë‹¨ê³„ë³„ ìƒíƒœ ì¶”ì¶œ (Succeeded, Failed, Skipped, Pending, Unknown)
            STATUS_DOWNLOAD=$(echo $EVENTS | jq -r '.[] | select(.lifecycleEventName=="DownloadBundle") | .status')
            STATUS_APP_START=$(echo $EVENTS | jq -r '.[] | select(.lifecycleEventName=="ApplicationStart") | .status')
            STATUS_VALIDATE=$(echo $EVENTS | jq -r '.[] | select(.lifecycleEventName=="ValidateService") | .status')
          
            echo "status_download=$STATUS_DOWNLOAD" >> $GITHUB_OUTPUT
            echo "status_app_start=$STATUS_APP_START" >> $GITHUB_OUTPUT
            echo "status_validate=$STATUS_VALIDATE" >> $GITHUB_OUTPUT
          
            # ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì›ì¸ ì¶”ì¶œ
            if [ "$STATUS" != "Succeeded" ]; then
               ERROR_STEP=$(echo $EVENTS | jq -r '.[] | select(.status=="Failed") | .lifecycleEventName')
               echo "error_step=$ERROR_STEP" >> $GITHUB_OUTPUT
            fi
          else
            echo "status_download=Unknown" >> $GITHUB_OUTPUT
            echo "status_app_start=Unknown" >> $GITHUB_OUTPUT
            echo "status_validate=Unknown" >> $GITHUB_OUTPUT
          fi

      - name: Discord CD ê²°ê³¼ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          status: ${{ steps.cd-check.outputs.status == 'Succeeded' && 'success' || 'failure' }}
          webhook: ${{ secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
          title: "ë°°í¬(CD) ê²°ê³¼ [${{ steps.cd-check.outputs.status == 'Succeeded' && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ë¸Œëœì¹˜**: `${{ github.ref_name }}`
            **CodeDeploy ID**: `${{ needs.deploy.outputs.deployment_id }}`
            
            **ğŸ“Š ë°°í¬ ìƒíƒœ**: ${{ steps.cd-check.outputs.status }}
            
            **ğŸ” ìƒì„¸ ì§„í–‰ ë‹¨ê³„**:
            - ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ: ${{ steps.cd-check.outputs.status_download == 'Succeeded' && 'âœ…Pass' || (steps.cd-check.outputs.status_download == 'Failed' && 'âŒFail' || 'â­ï¸Skip/Wait') }}
            - ìƒˆ ì„œë¹„ìŠ¤ ì‹¤í–‰: ${{ steps.cd-check.outputs.status_app_start == 'Succeeded' && 'âœ…Pass' || (steps.cd-check.outputs.status_app_start == 'Failed' && 'âŒFail' || 'â­ï¸Skip/Wait') }}
            - ê²€ì¦/ì „í™˜/ì¢…ë£Œ: ${{ steps.cd-check.outputs.status_validate == 'Succeeded' && 'âœ…Pass' || (steps.cd-check.outputs.status_validate == 'Failed' && 'âŒFail' || 'â­ï¸Skip/Wait') }}

            ${{ steps.cd-check.outputs.status != 'Succeeded' && format('**âš ï¸ ì‹¤íŒ¨ ë‹¨ê³„**: {0}', steps.cd-check.outputs.error_step) || '' }}

          color: "${{ steps.cd-check.outputs.status == 'Succeeded' && 65280 || 16711680 }}"
          username: AWS CodeDeploy Bot
          avatar_url: https://d1.awsstatic.com/icons/console/CodeDeploy_Icon.4ab321a5b8b9b2b2b2b2b2b2b2b2b2b2b2b2b2b.png
