name: Devths-BE CICD íŒŒì´í”„ë¼ì¸

# dev/release/main ëª¨ë‘ ì§„í–‰
on:
  push:
    branches: [ develop, release, main ]

# ENV ì„¤ì •
env:
  JAVA_VERSION: "21"
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
  S3_PREFIX: ${{ github.repository }}/${{ github.ref_name }}

jobs:
  # Lint ì„¤ì •
  lint:
    name: lint
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      checks: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Lint (CheckStyle) ìˆ˜í–‰
        run: ./gradlew checkstyleMain

      - name: Lint (CheckStyle) ê²°ê³¼ ë¦¬í¬íŠ¸
        uses: lcollins/checkstyle-github-action@v2.0.0
        if: always()
        with:
          path: '**/build/reports/checkstyle/*.xml'
          title: 'Checkstyle ê²°ê³¼ Report'

  # CodeQL ê¸°ë°˜ ì½”ë“œ ì •ì  ë¶„ì„ ì‹¤í–‰
  static_analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: true  # ì •ì  ë¶„ì„ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
      matrix:
        language: [ java-kotlin ]

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ë° Gradle ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          config-file: >-
            ${{ github.event_name == 'pull_request'
            && './.github/codeql/code-ql-light.yml'
            || './.github/codeql/code-ql-heavy.yml' }}

      - name: Build (Gradle)
        run: |
          chmod +x gradlew
          ./gradlew build -x test -x check

      - name: CodeQL ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
          upload: true

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê°œìˆ˜ í™•ì¸ ë° ë¹Œë“œ ì°¨ë‹¨ (Push)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # í˜„ì¬ Pushëœ ë¸Œëœì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          CURRENT_REF="${{ github.ref }}"
          echo "ğŸ” ë¶„ì„ ëŒ€ìƒ ë¸Œëœì¹˜: $CURRENT_REF"
          
          echo "â³ CodeQL ê²°ê³¼ ë°ì´í„° ë°˜ì˜ í™•ì¸ ì¤‘..."
          
          # Polling ë¡œì§: ë°ì´í„°ê°€ ì²˜ë¦¬ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          ALERTS_JSON="[]"
          for i in {1..10}; do
            # API í˜¸ì¶œ (íŠ¹ì • ë¸Œëœì¹˜ì˜ ëª¨ë“  open ìƒíƒœ ì·¨ì•½ì  ì¡°íšŒ)
            ALERTS_JSON=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=$CURRENT_REF")
          
            # ì‘ë‹µì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
            if [ -n "$ALERTS_JSON" ]; then
              echo "âœ… API ë°ì´í„° í™•ì¸ ì™„ë£Œ!"
              break
            fi
          
            echo "â³ ë°ì´í„° ë°˜ì˜ ëŒ€ê¸° ì¤‘... ($((i*5))s)"
            sleep 5
          done
          
          # ì „ì²´ ê²½ë¡œì—ì„œ ë³´ì•ˆ ì·¨ì•½ì  ê°œìˆ˜ ê³„ì‚° (vulnerable ì˜ˆì™¸ ì—†ìŒ)
          ALERTS_COUNT=$(echo "$ALERTS_JSON" | jq -r "[.[] | select(.rule.security_severity_level != null)] | length")
          
          echo "âš ï¸ ë°œê²¬ëœ ì´ ë³´ì•ˆ ì·¨ì•½ì : $ALERTS_COUNTê°œ"
          
          if [ "$ALERTS_COUNT" -gt 0 ]; then
            echo ""
            echo "ğŸ“‹ ì·¨ì•½ì  ìƒì„¸ ëª©ë¡ (ì „ì²´ ì½”ë“œ):"
            echo "$ALERTS_JSON" | jq -r '.[] | select(.rule.security_severity_level != null) | "  - [\(.rule.severity)] \(.rule.description) \n    ìœ„ì¹˜: \(.most_recent_instance.location.path):\(.most_recent_instance.location.start_line)"'
          
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ CRITICAL: ìš´ì˜ ë¸Œëœì¹˜ì— ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“Š ì´ ì·¨ì•½ì  ìˆ˜: $ALERTS_COUNTê°œ"
            echo "ğŸ”— ìƒì„¸ í™•ì¸: https://github.com/${{ github.repository }}/security/code-scanning"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
            # Job ì‹¤íŒ¨ ì²˜ë¦¬ -> Discord ì•Œë¦¼ì— âŒ ì „ì†¡ë¨
            exit 1
          else
            echo ""
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼! ëª¨ë“  ì½”ë“œê°€ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/*.jar
          retention-days: 1

  # ì¶”í›„ í†µí•© í…ŒìŠ¤íŠ¸ ê³¼ì • ì¶”ê°€ ì˜ˆì •

  # ë¹Œë“œ
  build:
    name: build
    runs-on: ubuntu-22.04
    needs: [ lint, static_analysis ] # í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ ë¹Œë“œ
    if: success()
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_KEY}}
          aws-region: ${{secrets.AWS_REGION}}

      - name: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
        id: timestamp
        run: echo "value=$(date +'%Y%m%d_%H%M%S')-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: JARì„ S3 ì—…ë¡œë“œ
        run: |
          set -euo pipefail
          DEST="s3://${S3_BUCKET}/${S3_PREFIX}/${{ steps.timestamp.outputs.value }}"

          # build/libs/*.jar ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          shopt -s nullglob
          files=(build/libs/*.jar)

          if [ ${#files[@]} -eq 0 ]; then
            echo "JARíŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          UPLOAD_COUNT=0
          for f in "${files[@]}"; do
            # íŒŒì¼ëª…ì— "-plain.jar"ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì—…ë¡œë“œ
            if [[ ! "$f" == *"-plain.jar" ]]; then
              echo "ğŸš€ Uploading: $(basename "$f")"
              aws s3 cp "$f" "${DEST}/$(basename "$f")" --only-show-errors
              UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
            else
              echo "â­ï¸ Skipping plain jar: $(basename "$f")"
            fi
          done

          if [ $UPLOAD_COUNT -eq 0 ]; then
            echo "ì‹¤í–‰ê°€ëŠ¥í•œ JARíŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

  # ë””ìŠ¤ì½”ë“œ ì•ŒëŒ ì œê³µ
  notify-discord:
    name: notify
    runs-on: ubuntu-22.04
    needs: [ lint, static_analysis, build ]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì»¤ë°‹ ë©”ì‹œì§€ ì¶”ì¶œ (Push ì œëª© ëŒ€ìš©)
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "title=$COMMIT_MSG" >> $GITHUB_OUTPUT

          # 2. ë¸Œëœì¹˜ ì •ë³´
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Discord ë¹Œë“œ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          status: ${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          # íƒ€ê²Ÿ ë¸Œëœì¹˜ì— ë”°ë¥¸ ì›¹í›… ë¶„ê¸°
          webhook: ${{ github.ref_name == 'main' && secrets.DISCORD_WEBHOOK_PROD_URL || secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
          title: "${{ steps.prep.outputs.branch }} ê²°ê³¼ [${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ì»¤ë°‹ ë©”ì‹œì§€**: ${{ steps.prep.outputs.title }}
            **ë¸Œëœì¹˜**: `${{ steps.prep.outputs.branch }}`
            **í™˜ê²½**: ${{ github.ref_name == 'main' && 'ğŸš€ ìš´ì˜(PROD)' || (github.ref_name == 'release' && 'ğŸ§ª ìŠ¤í…Œì´ì§•(STAGING)' || 'ğŸ› ï¸ ê°œë°œ(DEV)') }}
            
            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint: ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }}
            - Static Analysis: ${{ needs.static_analysis.result == 'success' && 'âœ…' || 'âŒ' }}
            - Build: ${{ needs.build.result == 'success' && 'âœ…' || (needs.build.result == 'skipped' && 'â­ï¸' || 'âŒ') }}

            ${{ needs.static_analysis.result != 'success' && 'âš ï¸ **ì •ì  ë¶„ì„ ì‹¤íŒ¨ë¡œ ì¸í•´ ë¹Œë“œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.**' || '' }}

            **ğŸ”— ë§í¬**: [ì»¤ë°‹ í™•ì¸í•˜ê¸°](${{ github.event.repository.html_url }}/commit/${{ github.sha }})

          color: "${{ (needs.lint.result == 'success' && needs.static_analysis.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub Merge Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
