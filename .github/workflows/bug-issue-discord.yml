name: Bug Issue Discord ì•Œë¦¼

on:
  issues:
    types: [ opened ]

jobs:
  notify-discord:
    name: notify-discord
    runs-on: ubuntu-22.04
    if: contains(github.event.issue.labels.*.name, 'bug')
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          set -euo pipefail

          # 1. ì œë³´ì ë§¤í•‘
          LOGIN_ID="${{ github.event.issue.user.login }}"
          REPORTER_TAG=$(echo "$USER_MAP" | jq -r --arg id "$LOGIN_ID" '.[$id] // $id')
          echo "reporter=$REPORTER_TAG" >> $GITHUB_OUTPUT

          # 2. ë‹´ë‹¹ì(Assignees) ë§¤í•‘
          ASSIGNEES_JSON='${{ toJson(github.event.issue.assignees) }}'
          ASSIGNEE_TAGS=$(echo "$ASSIGNEES_JSON" | jq -r --argjson map "$USER_MAP" '
            if length == 0 then "" else [.[].login | ($map[.] // .)] | join(", ") end
          ')
          echo "assignees=${ASSIGNEE_TAGS:-ì—†ìŒ}" >> $GITHUB_OUTPUT

          # 3. ì´ìŠˆ ë‚´ìš© ì •ë¦¬ (ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ì„œ ì „ì†¡)
          ISSUE_RAW_BODY=$(cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          )
          ISSUE_BODY=$(echo "$ISSUE_RAW_BODY" | tr '\n' ' ' | tr -s ' ' | head -c 800)
          echo "body=${ISSUE_BODY:-ë‚´ìš© ì—†ìŒ}" >> $GITHUB_OUTPUT

      - name: Discord Bug ì´ìŠˆ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          status: failure
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ğŸ Bug Issue ë°œìƒ"
          description: |
            **ì£¼ì†Œ**: `${{ github.repository }}#${{ github.event.issue.number }}`
            **ë§í¬**: [Issue í™•ì¸í•˜ê¸°](${{ github.event.issue.html_url }})
            **ì œëª©**: ${{ github.event.issue.title }}
            **ë‚´ìš©**: ${{ steps.prep.outputs.body }}

            **ì œë³´ì**: ${{ steps.prep.outputs.reporter }}
            **ë‹´ë‹¹ì**: ${{ steps.prep.outputs.assignees }}
          color: 16711680
          username: GitHub Issue Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
