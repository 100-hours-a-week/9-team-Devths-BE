name: Discord Bug Report Notification

on:
  issues:
    types: [opened]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'bug')

    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì‘ì„±ì ë§¤í•‘
          LOGIN_ID="${{ github.event.issue.user.login }}"
          AUTHOR_TAG=$(echo "$USER_MAP" | jq -r --arg id "$LOGIN_ID" '.[$id] // $id')
          echo "author=$AUTHOR_TAG" >> $GITHUB_OUTPUT

          # 2. ì‘ë‹µì ë§¤í•‘ (assignees)
          ASSIGNEES_JSON='${{ toJson(github.event.issue.assignees) }}'
          ASSIGNEE_TAGS=$(echo "$ASSIGNEES_JSON" | jq -r --argjson map "$USER_MAP" '
            [.[].login | ($map[.] // .)] | join(", ")
          ')
          echo "assignees=${ASSIGNEE_TAGS:-ì—†ìŒ}" >> $GITHUB_OUTPUT

          # 3. ì´ìŠˆ ë³¸ë¬¸ ì¶”ì¶œ (ìµœëŒ€ 500ì, ë§ˆí¬ë‹¤ìš´ ì œê±°)
          ISSUE_RAW_BODY=$(cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          )

          # ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì œê±° (í—¤ë”, ì´ëª¨ì§€ ë ˆì´ë¸” ë“±)
          DESC=$(echo "$ISSUE_RAW_BODY" | \
            sed 's/^#\+[[:space:]]*//g' | \
            sed 's/^[[:space:]]*-[[:space:]]*//g' | \
            sed 's/\*\*//g' | \
            sed 's/^ğŸ›[[:space:]]*ë²„ê·¸ ì„¤ëª…//g' | \
            sed 's/^ğŸ¯[[:space:]]*ì¬í˜„ ë°©ë²•//g' | \
            sed 's/^ğŸ–¥[[:space:]]*í™˜ê²½ ì •ë³´//g' | \
            sed 's/^ğŸ“¸[[:space:]]*ìŠ¤í¬ë¦°ìƒ·.*//g' | \
            sed '/^[[:space:]]*$/d' | \
            tr '\n' ' ' | \
            xargs | \
            head -c 500)
          echo "description=${DESC:-ë‚´ìš© ì—†ìŒ}" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        with:
          status: failure
          webhook: ${{ secrets.DISCORD_WEBHOOK_BUG_URL }}
          title: "ğŸ ìƒˆë¡œìš´ ë²„ê·¸ ë¦¬í¬íŠ¸"
          description: |
            ${{ secrets.DISCORD_ROLE_BE }}

            **ì œëª©**: ${{ github.event.issue.title }}
            **ì‘ì„±ì**: ${{ steps.prep.outputs.author }}
            **ë‹´ë‹¹ì**: ${{ steps.prep.outputs.assignees }}
            **ì´ìŠˆ ë²ˆí˜¸**: #${{ github.event.issue.number }}

            **ğŸ“ ë‚´ìš©**:
            ${{ steps.prep.outputs.description }}...

            **ğŸ”— ë§í¬**: [ì´ìŠˆ í™•ì¸í•˜ê¸°](${{ github.event.issue.html_url }})
          color: 16711680
          username: AWS Bug Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
